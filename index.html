<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û‡∏ô‡πâ‡∏≥ ‡∏ó‡∏≠.</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600;700&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Sarabun', sans-serif; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        [x-cloak] { display: none !important; }
        /* Animation ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô Tab */
        .fade-enter-active, .fade-leave-active { transition: opacity 0.2s ease; }
        .fade-enter-from, .fade-leave-to { opacity: 0; }
    </style>

    <script type="module">
        import Alpine from 'https://cdn.jsdelivr.net/npm/alpinejs@3.13.5/dist/module.esm.js';
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
        import { getDatabase, ref, push, set, onValue, remove, update, get, query, orderByChild, equalTo } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-database.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAXLLitg-7QyX7cA_WNU2iMdSvSsdbBHHk",
            authDomain: "water-queue-system.firebaseapp.com",
            databaseURL: "https://water-queue-system-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "water-queue-system",
            storageBucket: "water-queue-system.firebasestorage.app",
            messagingSenderId: "263603663598",
            appId: "1:263603663598:web:b7cad1f4d116425cf779ff",
            measurementId: "G-LLS33EN3PP"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const auth = getAuth(app);

        Alpine.data('appLogic', () => ({
            // System
            systemReady: false,
            currentTab: 'booking', // booking | history | staff_panel
            
            // Auth
            user: null,
            userRole: 'user', 
            userWing: '',
            authLoading: true,
            authMode: 'login',
            authForm: { email: '', password: '', wing: '' }, 
            authError: '',

            // App Data
            holidays: {}, 
            holidaysArray: [],
            userBookings: [], // ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ

            // Booking Wizard
            currentStep: 1, 
            form: { type: '', date: '' },
            loading: false,

            // Calendar Logic
            calDate: new Date(), // ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏™‡∏î‡∏á‡∏≠‡∏¢‡∏π‡πà
            calendarDays: [],
            
            // Staff Panel
            newHoliday: { date: '', name: '' },

            init() {
                console.log("System initializing...");
                onAuthStateChanged(auth, async (user) => {
                    this.user = user;
                    if (user) {
                        await this.fetchUserData(user);
                        this.loadHolidays();
                        this.loadUserBookings(); // ‡πÇ‡∏´‡∏•‡∏î‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥
                    } else {
                        this.resetUserState();
                    }
                    this.authLoading = false;
                    this.systemReady = true;
                });
            },

            async fetchUserData(user) {
                const userRef = ref(db, 'users/' + user.uid);
                const snapshot = await get(userRef);
                if (snapshot.exists()) {
                    const data = snapshot.val();
                    this.userRole = data.role || 'user';
                    this.userWing = data.wing || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô'; 
                } else {
                    this.userRole = 'user';
                    this.userWing = '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
                }
            },

            resetUserState() {
                this.userRole = 'user';
                this.userWing = '';
                this.currentStep = 1;
                this.userBookings = [];
            },

            loadHolidays() {
                const holidaysRef = ref(db, 'holidays');
                onValue(holidaysRef, (snapshot) => {
                    const data = snapshot.val() || {};
                    this.holidays = data;
                    this.holidaysArray = Object.keys(data).map(key => ({
                        date: key, name: data[key]
                    })).sort((a, b) => a.date.localeCompare(b.date));
                    
                    // Re-render calendar if open
                    if(this.currentStep === 2) this.generateCalendar();
                });
            },

            loadUserBookings() {
                if(!this.user) return;
                const bookingsRef = ref(db, 'bookings');
                // ‡∏î‡∏∂‡∏á‡∏°‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÅ‡∏•‡πâ‡∏ß Filter ‡∏ù‡∏±‡πà‡∏á Client (‡∏á‡πà‡∏≤‡∏¢‡∏Å‡∏ß‡πà‡∏≤‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Structure ‡∏ô‡∏µ‡πâ) 
                // ‡∏´‡∏£‡∏∑‡∏≠‡∏ñ‡πâ‡∏≤ data ‡πÄ‡∏¢‡∏≠‡∏∞‡∏Ñ‡∏ß‡∏£‡πÉ‡∏ä‡πâ query orderByChild('userId').equalTo(this.user.uid)
                onValue(bookingsRef, (snapshot) => {
                    const data = snapshot.val() || {};
                    this.userBookings = Object.keys(data)
                        .map(key => ({ id: key, ...data[key] }))
                        .filter(item => item.userId === this.user.uid || this.userRole === 'admin' || this.userRole === 'staff') // Admin/Staff ‡πÄ‡∏´‡πá‡∏ô‡∏´‡∏°‡∏î (‡∏´‡∏£‡∏∑‡∏≠‡πÅ‡∏Å‡πâ‡πÉ‡∏´‡πâ‡πÄ‡∏´‡πá‡∏ô‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Ç‡∏≠‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á‡∏Å‡πá‡πÑ‡∏î‡πâ)
                        .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                });
            },

            // --- AUTH ---
            toggleAuthMode() { this.authMode = this.authMode === 'login' ? 'register' : 'login'; this.authError = ''; },
            async handleAuth() {
                this.authError = '';
                if (!this.authForm.email || !this.authForm.password) { this.authError = '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö'; return; }
                if (this.authMode === 'register' && !this.authForm.wing) { this.authError = '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô'; return; }

                this.loading = true;
                try {
                    if (this.authMode === 'register') {
                        const cred = await createUserWithEmailAndPassword(auth, this.authForm.email, this.authForm.password);
                        await set(ref(db, 'users/' + cred.user.uid), {
                            email: this.authForm.email,
                            wing: this.authForm.wing,
                            role: 'user',
                            createdAt: new Date().toISOString()
                        });
                        this.userWing = this.authForm.wing;
                    } else {
                        await signInWithEmailAndPassword(auth, this.authForm.email, this.authForm.password);
                    }
                    this.authForm = { email: '', password: '', wing: '' };
                } catch (error) {
                    this.authError = '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.code;
                } finally {
                    this.loading = false;
                }
            },
            handleLogout() { signOut(auth); },

            // --- STAFF ---
            addHoliday() {
                if(!this.newHoliday.date || !this.newHoliday.name) return;
                set(ref(db, 'holidays/' + this.newHoliday.date), this.newHoliday.name);
                this.newHoliday = { date: '', name: '' };
            },
            deleteHoliday(dateKey) {
                if(confirm('‡∏•‡∏ö?')) remove(ref(db, 'holidays/' + dateKey));
            },

            // --- BOOKING & CALENDAR LOGIC ---
            selectType(typeName) { 
                this.form.type = typeName; 
                this.generateCalendar(); // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó
                this.nextStep(); 
            },
            nextStep() { if(this.currentStep < 2) this.currentStep++; },
            prevStep() { if(this.currentStep > 1) this.currentStep--; },

            // Calendar Generation
            changeMonth(offset) {
                this.calDate = new Date(this.calDate.getFullYear(), this.calDate.getMonth() + offset, 1);
                this.generateCalendar();
            },
            
            generateCalendar() {
                const year = this.calDate.getFullYear();
                const month = this.calDate.getMonth();
                const firstDay = new Date(year, month, 1).getDay(); // 0=Sun
                const daysInMonth = new Date(year, month + 1, 0).getDate();
                
                let days = [];
                // Empty slots for prev month
                for (let i = 0; i < firstDay; i++) {
                    days.push({ blank: true });
                }

                const today = new Date();
                today.setHours(0,0,0,0);

                for (let i = 1; i <= daysInMonth; i++) {
                    const dateObj = new Date(year, month, i);
                    const dateStr = dateObj.toISOString().split('T')[0]; // YYYY-MM-DD
                    
                    // Logic ‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô checkDate ‡πÄ‡∏î‡∏¥‡∏°)
                    let status = 'available'; // available, unavailable, selected
                    let reason = '';

                    // 1. Past Date
                    if (dateObj < today) {
                        status = 'unavailable'; reason = '‡∏ú‡πà‡∏≤‡∏ô‡∏°‡∏≤‡πÅ‡∏•‡πâ‡∏ß';
                    }
                    // 2. Holiday
                    else if (this.holidays[dateStr]) {
                        status = 'unavailable'; reason = this.holidays[dateStr];
                    }
                    // 3. Weekend
                    else if (dateObj.getDay() === 0 || dateObj.getDay() === 6) {
                        status = 'unavailable'; reason = '‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î‡πÄ‡∏™‡∏≤‡∏£‡πå-‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå';
                    }
                    else if (this.form.type === 'good') {
                        // Mon(1) - Wed(3)
                        if (dateObj.getDay() > 3) { status = 'unavailable'; reason = '‡∏£‡∏±‡∏ö‡πÄ‡∏â‡∏û‡∏≤‡∏∞ ‡∏à-‡∏û'; }
                    }
                    else if (this.form.type === 'waste') {
                        // Tue(2) - Thu(4)
                        if (dateObj.getDay() < 2 || dateObj.getDay() > 4) { 
                            status = 'unavailable'; reason = '‡∏£‡∏±‡∏ö‡πÄ‡∏â‡∏û‡∏≤‡∏∞ ‡∏≠-‡∏û‡∏§'; 
                        } else {
                            // BOD5 Check
                            const next5 = new Date(dateObj);
                            next5.setDate(dateObj.getDate() + 5);
                            const next5Str = next5.toISOString().split('T')[0];
                            if (next5.getDay() === 0 || next5.getDay() === 6) {
                                status = 'unavailable'; reason = '‡∏ß‡∏±‡∏ô‡∏≠‡πà‡∏≤‡∏ô‡∏ú‡∏•(5‡∏ß‡∏±‡∏ô) ‡∏ï‡∏£‡∏á‡πÄ‡∏™‡∏≤‡∏£‡πå‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå';
                            }
                            if (this.holidays[next5Str]) {
                                status = 'unavailable'; reason = `‡∏ß‡∏±‡∏ô‡∏≠‡πà‡∏≤‡∏ô‡∏ú‡∏•‡∏ï‡∏£‡∏á‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î (${this.holidays[next5Str]})`;
                            }
                        }
                    }

                    days.push({
                        day: i,
                        fullDate: dateStr,
                        status: status,
                        reason: reason,
                        selected: this.form.date === dateStr
                    });
                }
                this.calendarDays = days;
            },

            selectDate(dayObj) {
                if (dayObj.status === 'unavailable' || dayObj.blank) return;
                this.form.date = dayObj.fullDate;
                this.generateCalendar(); // Re-render to show selection
            },

            submit() {
                if (!this.form.date) return;
                this.loading = true;
                const newBookingRef = push(ref(db, 'bookings'));
                set(newBookingRef, {
                    ...this.form,
                    wing: this.userWing,
                    userId: this.user.uid,
                    userEmail: this.user.email,
                    timestamp: new Date().toISOString(),
                    status: '‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö' // Pending
                }).then(() => {
                    alert('üéâ ‡∏à‡∏≠‡∏á‡∏Ñ‡∏¥‡∏ß‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏î‡∏π‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÑ‡∏î‡πâ‡∏ó‡∏µ‡πà‡πÄ‡∏°‡∏ô‡∏π "‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏ú‡∏•"');
                    this.currentStep = 1; 
                    this.form = { type: '', date: '' };
                    this.currentTab = 'history'; // ‡πÄ‡∏î‡πâ‡∏á‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏ú‡∏•
                    this.loading = false;
                });
            },

            // Formats
            formatDate(dateStr) {
                if(!dateStr) return '-';
                const d = new Date(dateStr);
                return d.toLocaleDateString('th-TH', { year: 'numeric', month: 'short', day: 'numeric' });
            },
            getMonthName(date) {
                return date.toLocaleDateString('th-TH', { month: 'long', year: 'numeric' });
            },
            getStatusColor(status) {
                if(status === '‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö') return 'bg-yellow-100 text-yellow-800';
                if(status === '‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥/‡∏£‡∏±‡∏ö‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á') return 'bg-green-100 text-green-800';
                if(status === '‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò') return 'bg-red-100 text-red-800';
                if(status === '‡∏ú‡∏•‡∏≠‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß') return 'bg-blue-100 text-blue-800 font-bold';
                return 'bg-gray-100 text-gray-800';
            }
        }));
        Alpine.start();
    </script>
</head>
<body class="bg-slate-50 text-slate-800 h-screen flex flex-col overflow-hidden" x-data="appLogic()" x-cloak>

    <!-- Loading -->
    <div x-show="!systemReady" class="fixed inset-0 bg-white z-50 flex flex-col items-center justify-center">
        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-700"></div>
    </div>

    <!-- Header -->
    <header class="bg-gradient-to-r from-blue-800 to-indigo-900 text-white p-4 pt-8 shadow-lg z-20 rounded-b-[2rem] shrink-0">
        <div class="flex justify-between items-start max-w-md mx-auto">
            <div>
                <h1 class="text-lg font-bold leading-tight">‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û‡∏ô‡πâ‡∏≥ ‡∏ó‡∏≠.</h1>
                <p class="text-xs text-blue-200 opacity-90 mt-1">‡∏Å‡∏£‡∏°‡πÅ‡∏û‡∏ó‡∏¢‡πå‡∏ó‡∏´‡∏≤‡∏£‡∏≠‡∏≤‡∏Å‡∏≤‡∏®</p>
            </div>
            
            <template x-if="user">
                <div class="flex flex-col items-end text-right">
                    <div class="text-sm font-bold text-yellow-300" x-text="userWing"></div>
                    <div class="flex items-center space-x-2 mt-0.5">
                        <span class="text-[10px] bg-white/20 px-2 py-0.5 rounded-full" x-text="userRole === 'admin' ? 'Admin' : (userRole === 'staff' ? '‡∏à‡∏ô‡∏ó.' : 'User')"></span>
                        <span class="text-xs text-blue-100" x-text="user.email.split('@')[0]"></span>
                    </div>
                </div>
            </template>
        </div>
    </header>

    <!-- Main Content -->
    <main class="flex-1 relative max-w-md mx-auto w-full p-4 overflow-y-auto no-scrollbar pb-24">
        
        <!-- LOGIN -->
        <div x-show="!user && systemReady" class="flex flex-col items-center justify-center h-full space-y-6">
            <div class="text-center">
                <h2 class="text-xl font-bold text-slate-800">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</h2>
                <p class="text-sm text-slate-500">‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏à‡∏≠‡∏á‡∏Ñ‡∏¥‡∏ß‡πÅ‡∏•‡∏∞‡∏î‡∏π‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à</p>
            </div>
            <div class="w-full bg-white p-6 rounded-2xl shadow-sm border space-y-4">
                <div x-show="authMode === 'register'">
                    <label class="text-xs font-bold text-slate-500 ml-1">‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô</label>
                    <input type="text" x-model="authForm.wing" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô" class="w-full p-3 rounded-xl border bg-slate-50 mt-1">
                </div>
                <div>
                    <label class="text-xs font-bold text-slate-500 ml-1">‡∏≠‡∏µ‡πÄ‡∏°‡∏•</label>
                    <input type="email" x-model="authForm.email" placeholder="Email" class="w-full p-3 rounded-xl border bg-slate-50 mt-1">
                </div>
                <div>
                    <label class="text-xs font-bold text-slate-500 ml-1">‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</label>
                    <input type="password" x-model="authForm.password" placeholder="Password" class="w-full p-3 rounded-xl border bg-slate-50 mt-1">
                </div>
                <p x-show="authError" x-text="authError" class="text-red-500 text-xs text-center"></p>
                <button @click="handleAuth()" :disabled="loading" class="w-full py-3 rounded-xl text-white font-bold bg-blue-600 shadow-md">
                    <span x-show="!loading" x-text="authMode === 'login' ? '‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö' : '‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô'"></span>
                    <span x-show="loading">...</span>
                </button>
            </div>
            <button @click="toggleAuthMode()" class="text-sm text-blue-600 underline" x-text="authMode === 'login' ? '‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡πÉ‡∏´‡∏°‡πà' : '‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö'"></button>
        </div>

        <!-- 1. BOOKING TAB -->
        <template x-if="user && currentTab === 'booking'">
            <div class="h-full flex flex-col">
                <!-- Step 1: ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó -->
                <div x-show="currentStep === 1" class="space-y-4 animate-fade-in">
                    <h2 class="text-xl font-bold text-center text-slate-700 mb-2">‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏Ñ‡∏¥‡∏ß</h2>
                    
                    <button @click="selectType('good')" class="w-full p-6 rounded-2xl border-2 hover:border-blue-500 bg-white shadow-sm flex items-center justify-between transition-all hover:bg-blue-50">
                        <div class="text-left">
                            <div class="text-lg font-bold text-blue-700">‡∏ô‡πâ‡∏≥‡∏î‡∏µ (‡∏õ‡∏£‡∏∞‡∏õ‡∏≤)</div>
                            <div class="text-xs text-gray-500">‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå - ‡∏û‡∏∏‡∏ò</div>
                        </div>
                        <div class="text-3xl">üíß</div>
                    </button>
                    
                    <button @click="selectType('waste')" class="w-full p-6 rounded-2xl border-2 hover:border-red-500 bg-white shadow-sm flex items-center justify-between transition-all hover:bg-red-50">
                        <div class="text-left">
                            <div class="text-lg font-bold text-red-700">‡∏ô‡πâ‡∏≥‡πÄ‡∏™‡∏µ‡∏¢</div>
                            <div class="text-xs text-gray-500">‡∏≠‡∏±‡∏á‡∏Ñ‡∏≤‡∏£ - ‡∏û‡∏§‡∏´‡∏±‡∏™ (‡∏ö‡πà‡∏° 5 ‡∏ß‡∏±‡∏ô)</div>
                        </div>
                        <div class="text-3xl">üß™</div>
                    </button>
                </div>

                <!-- Step 2: ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà (‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô) -->
                <div x-show="currentStep === 2" class="space-y-4 animate-fade-in">
                    <div class="flex items-center justify-between">
                        <button @click="prevStep()" class="text-sm text-gray-500 flex items-center"><svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg> ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö</button>
                        <h3 class="font-bold text-slate-700" x-text="form.type==='good'?'‡∏à‡∏≠‡∏á‡∏Ñ‡∏¥‡∏ß‡∏ô‡πâ‡∏≥‡∏î‡∏µ':'‡∏à‡∏≠‡∏á‡∏Ñ‡∏¥‡∏ß‡∏ô‡πâ‡∏≥‡πÄ‡∏™‡∏µ‡∏¢'"></h3>
                    </div>

                    <!-- Calendar Component -->
                    <div class="bg-white rounded-2xl shadow-sm border p-4">
                        <!-- Cal Header -->
                        <div class="flex justify-between items-center mb-4">
                            <button @click="changeMonth(-1)" class="p-2 hover:bg-gray-100 rounded-full text-gray-600"><</button>
                            <div class="font-bold text-lg text-slate-800" x-text="getMonthName(calDate)"></div>
                            <button @click="changeMonth(1)" class="p-2 hover:bg-gray-100 rounded-full text-gray-600">></button>
                        </div>
                        
                        <!-- Weekdays -->
                        <div class="grid grid-cols-7 mb-2 text-center">
                            <div class="text-xs text-red-500 font-bold">‡∏≠‡∏≤</div>
                            <div class="text-xs text-gray-500">‡∏à</div>
                            <div class="text-xs text-gray-500">‡∏≠</div>
                            <div class="text-xs text-gray-500">‡∏û</div>
                            <div class="text-xs text-gray-500">‡∏û‡∏§</div>
                            <div class="text-xs text-gray-500">‡∏®</div>
                            <div class="text-xs text-red-500 font-bold">‡∏™</div>
                        </div>

                        <!-- Days -->
                        <div class="grid grid-cols-7 gap-1">
                            <template x-for="d in calendarDays">
                                <div>
                                    <template x-if="d.blank">
                                        <div class="h-10"></div>
                                    </template>
                                    <template x-if="!d.blank">
                                        <button @click="selectDate(d)" 
                                            class="w-full h-12 rounded-lg flex flex-col items-center justify-center text-xs relative transition-all border border-transparent"
                                            :class="{
                                                'bg-gray-50 text-gray-300 cursor-not-allowed': d.status === 'unavailable',
                                                'bg-green-50 text-green-700 hover:bg-green-100 hover:border-green-300 font-bold': d.status === 'available' && !d.selected,
                                                'bg-blue-600 text-white shadow-md transform scale-105 z-10': d.selected
                                            }">
                                            <span x-text="d.day" class="text-sm"></span>
                                            <!-- Status Dot/Text -->
                                            <span x-show="d.status==='unavailable'" class="text-[8px] leading-tight px-1 truncate w-full" x-text="d.reason"></span>
                                            <span x-show="d.status==='available' && !d.selected" class="text-[8px] text-green-600">‡∏ß‡πà‡∏≤‡∏á</span>
                                            <span x-show="d.selected" class="text-[8px] text-white">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</span>
                                        </button>
                                    </template>
                                </div>
                            </template>
                        </div>
                    </div>

                    <!-- Confirm Area -->
                    <div x-show="form.date" class="bg-blue-50 p-4 rounded-xl border border-blue-100 text-center">
                        <div class="text-sm text-blue-800 mb-1">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</div>
                        <div class="text-xl font-bold text-blue-900" x-text="formatDate(form.date)"></div>
                        <button @click="submit()" :disabled="loading" class="w-full mt-3 py-3 bg-blue-600 text-white rounded-xl font-bold shadow-lg">
                            <span x-show="!loading">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á</span>
                            <span x-show="loading">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...</span>
                        </button>
                    </div>
                </div>
            </div>
        </template>

        <!-- 2. HISTORY TAB -->
        <template x-if="user && currentTab === 'history'">
            <div class="h-full flex flex-col space-y-4">
                <h2 class="text-xl font-bold text-center text-slate-700">‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à</h2>
                
                <div class="flex-1 overflow-y-auto space-y-3">
                    <template x-for="book in userBookings" :key="book.id">
                        <div class="bg-white p-4 rounded-xl border shadow-sm relative overflow-hidden">
                            <div class="flex justify-between items-start mb-2">
                                <div>
                                    <div class="text-xs text-gray-500">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á</div>
                                    <div class="font-bold text-slate-800" x-text="formatDate(book.date)"></div>
                                </div>
                                <span class="text-[10px] px-2 py-1 rounded-full border" 
                                      :class="getStatusColor(book.status)" 
                                      x-text="book.status"></span>
                            </div>
                            <div class="flex items-center text-xs text-gray-500 space-x-2">
                                <span x-text="book.type==='good'?'üíß ‡∏ô‡πâ‡∏≥‡∏î‡∏µ':'üß™ ‡∏ô‡πâ‡∏≥‡πÄ‡∏™‡∏µ‡∏¢'"></span>
                                <span>‚Ä¢</span>
                                <span x-text="book.wing"></span>
                            </div>
                            <!-- ‡∏™‡πà‡∏ß‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ) -->
                            <template x-if="book.resultLink">
                                <a :href="book.resultLink" target="_blank" class="mt-3 block text-center w-full py-2 bg-blue-50 text-blue-700 text-xs font-bold rounded-lg hover:bg-blue-100">
                                    üìÑ ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ú‡∏•
                                </a>
                            </template>
                        </div>
                    </template>
                    
                    <div x-show="userBookings.length === 0" class="text-center py-10 text-gray-400">
                        <div class="text-4xl mb-2">üì≠</div>
                        ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á
                    </div>
                </div>
            </div>
        </template>

        <!-- 3. STAFF TAB (Visible to all for demo, usually restricts) -->
        <template x-if="user && currentTab === 'staff_panel'">
            <div class="space-y-4">
                <h2 class="text-xl font-bold text-center text-slate-700">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏∞‡∏ö‡∏ö (‡∏à‡∏ô‡∏ó.)</h2>
                
                <div class="bg-yellow-50 p-4 rounded-xl border border-yellow-200">
                    <h3 class="font-bold text-yellow-800 mb-2 text-sm">‡∏õ‡∏¥‡∏î‡∏£‡∏±‡∏ö‡∏à‡∏≠‡∏á (‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î/‡∏≠‡∏≠‡∏Å‡∏ï‡∏£‡∏ß‡∏à)</h3>
                    <div class="flex space-x-2">
                        <input type="date" x-model="newHoliday.date" class="p-2 rounded border w-1/3 text-sm">
                        <input type="text" x-model="newHoliday.name" placeholder="‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏" class="p-2 rounded border flex-1 text-sm">
                        <button @click="addHoliday()" class="bg-yellow-600 text-white px-3 rounded font-bold hover:bg-yellow-700 text-sm">+</button>
                    </div>
                </div>

                <div class="bg-white rounded-xl shadow-sm border overflow-hidden">
                    <div class="bg-slate-100 p-2 text-xs font-bold text-slate-600 px-4">‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö</div>
                    <div class="divide-y max-h-64 overflow-y-auto">
                        <template x-for="h in holidaysArray">
                            <div class="p-3 flex justify-between items-center text-sm">
                                <div>
                                    <div class="font-bold text-slate-800" x-text="formatDate(h.date)"></div>
                                    <div class="text-xs text-slate-500" x-text="h.name"></div>
                                </div>
                                <button @click="deleteHoliday(h.date)" class="text-red-500">‡∏•‡∏ö</button>
                            </div>
                        </template>
                    </div>
                </div>
            </div>
        </template>
    </main>

    <!-- TAB BAR NAVIGATION (Bottom) -->
    <nav x-show="user" class="bg-white border-t border-slate-200 fixed bottom-0 w-full max-w-md pb-safe">
        <div class="flex justify-around items-center h-16">
            <button @click="currentTab = 'booking'" class="flex flex-col items-center justify-center w-full h-full space-y-1 transition-colors"
                :class="currentTab === 'booking' ? 'text-blue-600' : 'text-gray-400'">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                </svg>
                <span class="text-[10px] font-bold">‡∏à‡∏≠‡∏á‡∏Ñ‡∏¥‡∏ß</span>
            </button>
            
            <button @click="currentTab = 'history'" class="flex flex-col items-center justify-center w-full h-full space-y-1 transition-colors"
                :class="currentTab === 'history' ? 'text-blue-600' : 'text-gray-400'">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01" />
                </svg>
                <span class="text-[10px] font-bold">‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏ú‡∏•</span>
            </button>

            <template x-if="userRole === 'admin' || userRole === 'staff'">
                <button @click="currentTab = 'staff_panel'" class="flex flex-col items-center justify-center w-full h-full space-y-1 transition-colors"
                    :class="currentTab === 'staff_panel' ? 'text-yellow-600' : 'text-gray-400'">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                    </svg>
                    <span class="text-[10px] font-bold">‡∏à‡∏ô‡∏ó.</span>
                </button>
            </template>

            <button @click="handleLogout()" class="flex flex-col items-center justify-center w-full h-full space-y-1 text-red-400 hover:text-red-600">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
                </svg>
                <span class="text-[10px] font-bold">‡∏≠‡∏≠‡∏Å</span>
            </button>
        </div>
    </nav>

</body>
</html>
