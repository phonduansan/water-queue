<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบจองคิวส่งน้ำ ทอ.</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
        import { getDatabase, ref, push, set, onValue } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-database.js";

        // --- 1. เอาค่าจาก Firebase มาใส่ตรงนี้ ---
        const firebaseConfig = {
            apiKey: "AIzaSyAXLLitg-7QyX7cA_WNU2iMdSvSsdbBHHk", 
            authDomain: "water-queue-system.firebaseapp.com",
            databaseURL: "https://water-queue-system-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "water-queue-system",
            storageBucket: "water-queue-system.firebasestorage.app",
            messagingSenderId: "263603663598",
            appId: "1:263603663598:web:b7cad1f4d116425cf779ff"
        };
        // -------------------------------------

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // ส่งตัวแปรให้ AlpineJS ใช้งาน
        window.db = db;
        window.dbRef = ref;
        window.dbPush = push;
        window.dbSet = set;
        window.dbOnValue = onValue;
    </script>
</head>
<body class="bg-gray-100 min-h-screen" x-data="appLogic()">

    <div class="max-w-md mx-auto bg-white min-h-screen shadow-lg flex flex-col">
        <div class="bg-blue-800 p-5 text-white rounded-b-3xl shadow-md z-10">
            <h1 class="text-2xl font-bold">จองคิวส่งน้ำ</h1>
            <p class="text-sm opacity-80">ระบบตรวจสอบคุณภาพน้ำ (สิ่งแวดล้อม)</p>
        </div>

        <div class="flex-1 p-6 space-y-6">
            
            <div>
                <label class="font-bold text-gray-700">หน่วยงาน</label>
                <select x-model="form.wing" class="w-full mt-2 p-3 border rounded-xl bg-gray-50">
                    <option value="">-- กรุณาเลือก --</option>
                    <template x-for="i in 17">
                        <option :value="'กองบิน ' + i" x-text="'กองบิน ' + i"></option>
                    </template>
                </select>
            </div>

            <div>
                <label class="font-bold text-gray-700">ประเภทน้ำ</label>
                <div class="grid grid-cols-2 gap-4 mt-2">
                    <div @click="setWaterType('good')" 
                         class="p-4 rounded-xl border-2 text-center cursor-pointer transition-all"
                         :class="form.type === 'good' ? 'border-blue-500 bg-blue-50 text-blue-700' : 'border-gray-200'">
                        <div class="font-bold">น้ำดี</div>
                        <div class="text-xs text-gray-500">จันทร์ - พุธ</div>
                    </div>
                    <div @click="setWaterType('waste')"
                         class="p-4 rounded-xl border-2 text-center cursor-pointer transition-all"
                         :class="form.type === 'waste' ? 'border-red-500 bg-red-50 text-red-700' : 'border-gray-200'">
                        <div class="font-bold">น้ำเสีย</div>
                        <div class="text-xs text-red-500">อังคาร - พุธ</div>
                    </div>
                </div>
                <div x-show="form.type === 'waste'" class="mt-2 text-xs text-red-500 bg-red-50 p-2 rounded">
                    *น้ำเสียต้องบ่ม 5 วัน (BOD5) ระบบจะคำนวณวันหยุดปลายทางให้
                </div>
            </div>

            <div>
                <label class="font-bold text-gray-700">วันที่ต้องการส่ง</label>
                <input type="date" x-model="form.date" @change="checkDate()" 
                       class="w-full mt-2 p-3 border rounded-xl text-lg font-mono">
                
                <div x-show="form.date" class="mt-3">
                    <div x-show="errorMsg" class="flex items-center text-red-600 bg-red-50 p-3 rounded-lg">
                        <span class="mr-2">❌</span> <span x-text="errorMsg"></span>
                    </div>
                    <div x-show="!errorMsg && form.date" class="flex items-center text-green-700 bg-green-50 p-3 rounded-lg">
                        <span class="mr-2">✅</span> <span>วันที่นี้จองได้</span>
                    </div>
                </div>
            </div>

            <button @click="submit()" 
                    :disabled="!isValid || loading"
                    class="w-full py-4 rounded-xl text-white font-bold text-lg shadow-lg transition-transform active:scale-95"
                    :class="isValid ? 'bg-blue-600 hover:bg-blue-700' : 'bg-gray-300 cursor-not-allowed'">
                <span x-show="!loading">ยืนยันการจองคิว</span>
                <span x-show="loading">กำลังบันทึก...</span>
            </button>
        </div>
    </div>

    <script>
        document.addEventListener('alpine:init', () => {
            Alpine.data('appLogic', () => ({
                holidays: {}, 
                form: { wing: '', type: 'good', date: '' },
                errorMsg: '',
                isValid: false,
                loading: false,

                init() {
                    // ดึงข้อมูลวันหยุดจาก Firebase (Node: holidays)
                    const holidaysRef = window.dbRef(window.db, 'holidays');
                    window.dbOnValue(holidaysRef, (snapshot) => {
                        this.holidays = snapshot.val() || {};
                    });
                },

                setWaterType(type) {
                    this.form.type = type;
                    this.checkDate(); // เช็คใหม่ทันทีที่เปลี่ยนประเภท
                },

                checkDate() {
                    this.isValid = false;
                    this.errorMsg = '';
                    if (!this.form.date) return;

                    const dateObj = new Date(this.form.date);
                    const day = dateObj.getDay(); // 0=Sun, 1=Mon, 2=Tue...
                    const dateStr = this.form.date;

                    // 1. เช็ควันหยุดราชการ/วันออกตรวจ (ต้นทาง)
                    if (this.holidays[dateStr]) {
                        this.errorMsg = `ตรงกับวันหยุด: ${this.holidays[dateStr]}`;
                        return;
                    }
                    if (day === 0 || day === 6) {
                        this.errorMsg = "ไม่รับส่งวันเสาร์-อาทิตย์";
                        return;
                    }

                    // 2. เช็คเงื่อนไข น้ำดี
                    if (this.form.type === 'good') {
                        if (day > 3) { // มากกว่าพุธ (พฤ, ศ)
                            this.errorMsg = "น้ำดีส่งได้เฉพาะ จันทร์-พุธ";
                            return;
                        }
                    }

                    // 3. เช็คเงื่อนไข น้ำเสีย (BOD5)
                    if (this.form.type === 'waste') {
                        if (day !== 2 && day !== 3) { // ไม่ใช่อังคาร/พุธ
                            this.errorMsg = "น้ำเสียส่งได้เฉพาะ อังคาร-พุธ";
                            return;
                        }
                        
                        // นับไป 5 วัน
                        const next5 = new Date(dateObj);
                        next5.setDate(dateObj.getDate() + 5);
                        const day5 = next5.getDay();
                        const next5Str = next5.toISOString().split('T')[0];

                        if (day5 === 0 || day5 === 6) {
                            this.errorMsg = "วันครบกำหนดอ่านค่า (5 วัน) ตรงกับ เสาร์-อาทิตย์";
                            return;
                        }
                        if (this.holidays[next5Str]) {
                            this.errorMsg = `วันครบกำหนดอ่านค่า ตรงกับวันหยุด (${this.holidays[next5Str]})`;
                            return;
                        }
                    }

                    this.isValid = true;
                },

                submit() {
                    if (!this.form.wing) return alert('กรุณาเลือกกองบิน');
                    this.loading = true;

                    // บันทึกลง Firebase (Node: bookings)
                    const newBookingRef = window.dbPush(window.dbRef(window.db, 'bookings'));
                    window.dbSet(newBookingRef, {
                        ...this.form,
                        timestamp: new Date().toISOString()
                    }).then(() => {
                        alert('✅ จองคิวสำเร็จ!');
                        this.form.date = '';
                        this.checkDate();
                        this.loading = false;
                    }).catch((e) => {
                        alert('เกิดข้อผิดพลาด: ' + e.message);
                        this.loading = false;
                    });
                }
            }))
        });
    </script>
</body>
</html>